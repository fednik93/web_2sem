from django.shortcuts import render
from django.utils import timezone
from django.db.models import Count
from .models import Room, Booking, Location

def home(request):
    # 1) Топ популярных комнат (Room) по количеству бронирований:
    popular_places = (
        Room.objects
        .annotate(num_bookings=Count('bookings'))  # related_name='bookings' в модели Booking
        .order_by('-num_bookings')[:5]
    )

    # 2) Ближайшие бронирования (Booking):
    upcoming_bookings = (
        Booking.objects
        .filter(date__gte=timezone.now().date())
        .order_by('date')[:5]
    )

    # 3) Список всех площадок (Location) для селекта поиска:
    locations = Location.objects.all()

    return render(request, 'home.html', {
        'popular_places': popular_places,
        'upcoming_bookings': upcoming_bookings,
        'locations': locations,
    })
